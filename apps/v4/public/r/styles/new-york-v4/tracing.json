{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "tracing",
  "type": "registry:lib",
  "description": "OpenTelemetry tracing for shadcn/ui components",
  "dependencies": [
    "@opentelemetry/api",
    "@opentelemetry/sdk-trace-web",
    "@opentelemetry/exporter-trace-otlp-http"
  ],
  "files": [
    {
      "path": "registry/new-york-v4/lib/tracing/tracer.ts",
      "content": "'use client'\n\nimport { trace, context, SpanStatusCode } from '@opentelemetry/api'\nimport type { \n  ComponentTraceEvent, \n  ComponentTraceAttributes,\n  ComponentStatusCode,\n  InteractionType \n} from './types'\nimport { ComponentStatus } from './types'\n\n/**\n * Client-side tracer for component interactions\n * \n * Maps component status codes to OpenTelemetry span status\n * Automatically tracks session IDs to correlate user actions\n */\n\nconst tracer = trace.getTracer('component-tracer', '1.0.0')\n\n// Session management\nconst SESSION_STORAGE_KEY = 'otel_session_id'\nconst SESSION_TIMEOUT = 30 * 60 * 1000 // 30 minutes\n\nclass SessionManager {\n  private static sessionId: string | null = null\n  private static lastActivity: number = Date.now()\n\n  static getSessionId(): string {\n    if (typeof window === 'undefined') return 'server-session'\n\n    // Check if session expired\n    if (Date.now() - this.lastActivity > SESSION_TIMEOUT) {\n      this.sessionId = null\n    }\n\n    // Get or create session\n    if (!this.sessionId) {\n      // Try to restore from sessionStorage\n      const stored = sessionStorage.getItem(SESSION_STORAGE_KEY)\n      if (stored) {\n        const { id, timestamp } = JSON.parse(stored)\n        if (Date.now() - timestamp < SESSION_TIMEOUT) {\n          this.sessionId = id\n          this.lastActivity = timestamp\n        }\n      }\n\n      // Create new session if needed\n      if (!this.sessionId) {\n        this.sessionId = this.generateSessionId()\n        this.saveSession()\n      }\n    }\n\n    // Update activity timestamp\n    this.lastActivity = Date.now()\n    this.saveSession()\n\n    return this.sessionId\n  }\n\n  private static generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`\n  }\n\n  private static saveSession(): void {\n    if (typeof window === 'undefined' || !this.sessionId) return\n    \n    sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({\n      id: this.sessionId,\n      timestamp: this.lastActivity\n    }))\n  }\n\n  static clearSession(): void {\n    this.sessionId = null\n    if (typeof window !== 'undefined') {\n      sessionStorage.removeItem(SESSION_STORAGE_KEY)\n    }\n  }\n}\n\nexport class ComponentTracer {\n  /**\n   * Record a component interaction\n   */\n  static recordInteraction(\n    componentName: string,\n    interaction: InteractionType,\n    attributes: Partial<ComponentTraceAttributes> = {},\n    statusCode: ComponentStatusCode = ComponentStatus.OK\n  ): void {\n    const span = tracer.startSpan(`${componentName}.${interaction}`, {\n      kind: 1, // INTERNAL\n      startTime: Date.now(),\n    })\n\n    // Auto-capture current page from URL\n    const currentPage = typeof window !== 'undefined' ? window.location.pathname : '/'\n\n    // Get session ID\n    const sessionId = SessionManager.getSessionId()\n\n    // Set component attributes\n    span.setAttributes({\n      'component.name': componentName,\n      'component.interaction': interaction,\n      'component.status': statusCode,\n      'component.type': attributes['component.type'] as string || 'component',\n      'page': (attributes['page'] as string) || currentPage, // Use provided page or auto-detect\n      'session.id': sessionId, // Track user session\n    })\n    \n    // Add all additional attributes\n    Object.entries(attributes).forEach(([key, value]) => {\n      // Skip already set attributes and complex objects\n      if (key === 'component.name' || key === 'component.interaction' || key === 'component.status' || key === 'component.type' || key === 'page' || key === 'session.id') {\n        return\n      }\n      \n      // Only add primitive values (string, number, boolean)\n      if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n        span.setAttribute(key, value)\n      }\n    })\n\n    // Map component status to OTEL status\n    const otelStatus = this.mapStatusCode(statusCode)\n    span.setStatus(otelStatus)\n\n    // End span immediately for synchronous interactions\n    span.end()\n  }\n\n  /**\n   * Start a traced operation (for async operations)\n   */\n  static startOperation(\n    componentName: string,\n    interaction: InteractionType,\n    attributes: Partial<ComponentTraceAttributes> = {}\n  ) {\n    const span = tracer.startSpan(`${componentName}.${interaction}`, {\n      kind: 1,\n      startTime: Date.now(),\n    })\n\n    // Auto-capture current page from URL\n    const currentPage = typeof window !== 'undefined' ? window.location.pathname : '/'\n\n    // Get session ID\n    const sessionId = SessionManager.getSessionId()\n\n    span.setAttributes({\n      'component.name': componentName,\n      'component.interaction': interaction,\n      'component.type': attributes['component.type'] as string || 'component',\n      'page': (attributes['page'] as string) || currentPage,\n      'session.id': sessionId,\n    })\n\n    return {\n      end: (statusCode: ComponentStatusCode = ComponentStatus.OK, error?: Error) => {\n        span.setAttribute('component.status', statusCode)\n        \n        if (error) {\n          span.setAttribute('component.error', error.message)\n          span.recordException(error)\n        }\n\n        const otelStatus = this.mapStatusCode(statusCode)\n        span.setStatus(otelStatus)\n        span.end()\n      }\n    }\n  }\n\n  /**\n   * Record a component render\n   */\n  static recordRender(\n    componentName: string,\n    duration?: number,\n    props?: Record<string, unknown>\n  ): void {\n    this.recordInteraction(\n      componentName,\n      'render',\n      {\n        'component.duration_ms': duration,\n        'component.props': props,\n        'component.type': 'component',\n      },\n      ComponentStatus.OK\n    )\n  }\n\n  /**\n   * Record a component error\n   */\n  static recordError(\n    componentName: string,\n    error: Error,\n    interaction: InteractionType = 'error'\n  ): void {\n    this.recordInteraction(\n      componentName,\n      interaction,\n      {\n        'component.error': error.message,\n        'component.type': 'error',\n      },\n      ComponentStatus.ERROR\n    )\n  }\n\n  /**\n   * Map component status codes to OpenTelemetry status\n   */\n  private static mapStatusCode(statusCode: ComponentStatusCode): { code: SpanStatusCode, message?: string } {\n    if (statusCode >= 200 && statusCode < 300) {\n      return { code: SpanStatusCode.OK }\n    }\n    \n    if (statusCode >= 400 && statusCode < 500) {\n      return { \n        code: SpanStatusCode.ERROR, \n        message: `Client error: ${statusCode}` \n      }\n    }\n    \n    if (statusCode >= 500) {\n      return { \n        code: SpanStatusCode.ERROR, \n        message: `Server error: ${statusCode}` \n      }\n    }\n\n    return { code: SpanStatusCode.UNSET }\n  }\n}\n\n/**\n * Utility: Measure component render time\n */\nexport function measureRender<T>(\n  componentName: string,\n  renderFn: () => T\n): T {\n  const start = performance.now()\n  const result = renderFn()\n  const duration = performance.now() - start\n\n  ComponentTracer.recordRender(componentName, duration)\n  \n  return result\n}\n\n/**\n * Export session manager for manual session control\n */\nexport { SessionManager }\n",
      "type": "registry:lib"
    },
    {
      "path": "registry/new-york-v4/lib/tracing/client-instrumentation.ts",
      "content": "'use client'\n\n/**\n * Client-side OpenTelemetry Instrumentation\n * \n * Initializes OTEL in the browser to send component traces to the collector\n */\n\nimport { WebTracerProvider } from '@opentelemetry/sdk-trace-web'\nimport { BatchSpanProcessor } from '@opentelemetry/sdk-trace-base'\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http'\nimport { registerInstrumentations } from '@opentelemetry/instrumentation'\nimport { DocumentLoadInstrumentation } from '@opentelemetry/instrumentation-document-load'\nimport { UserInteractionInstrumentation } from '@opentelemetry/instrumentation-user-interaction'\nimport { ZoneContextManager } from '@opentelemetry/context-zone'\nimport { resourceFromAttributes } from '@opentelemetry/resources'\nimport { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions'\n\nlet isInitialized = false\n\nexport function initializeClientTracing() {\n  // Only initialize once\n  if (isInitialized || typeof window === 'undefined') {\n    return\n  }\n\n  console.log('üîç [Client Tracing] Initializing...')\n\n  try {\n    // Configure OTLP exporter to use Next.js API proxy (avoids CORS)\n    const exporter = new OTLPTraceExporter({\n      url: '/api/traces', // Proxy through Next.js API route\n    })\n\n    // Create batch processor\n    const batchProcessor = new BatchSpanProcessor(exporter)\n\n    // Create tracer provider with service name\n    const provider = new WebTracerProvider({\n      resource: resourceFromAttributes({\n        [ATTR_SERVICE_NAME]: 'v4-app-client',\n      }),\n      spanProcessors: [batchProcessor],\n    })\n\n    // Register the provider\n    provider.register({\n      contextManager: new ZoneContextManager(),\n    })\n\n    isInitialized = true\n    console.log('‚úÖ [Client Tracing] Initialized successfully')\n    console.log('üìç Sending traces via proxy: /api/traces ‚Üí http://localhost:4318/v1/traces')\n  } catch (error) {\n    console.error('‚ùå [Client Tracing] Failed to initialize:', error)\n  }\n}\n",
      "type": "registry:lib"
    },
    {
      "path": "registry/new-york-v4/lib/tracing/types.ts",
      "content": "/**\n * Component Tracing Types\n * \n * Based on TRACING_SPEC.md - Declarative observability for UI components\n * Components report interactions like APIs with HTTP-like status codes\n */\n\n// HTTP-like status codes for UI components\nexport const ComponentStatus = {\n  // 2xx: Success\n  OK: 200,                    // Component rendered/interacted successfully\n  CREATED: 201,               // Component created/mounted successfully\n  ACCEPTED: 202,              // Async operation accepted\n  NO_CONTENT: 204,            // Action completed, no output needed\n  \n  // 4xx: Client/User errors\n  BAD_REQUEST: 400,           // Invalid props/input\n  UNAUTHORIZED: 401,          // Auth required\n  FORBIDDEN: 403,             // Action not allowed\n  NOT_FOUND: 404,             // Resource not found\n  VALIDATION_ERROR: 422,      // Form validation failed\n  \n  // 5xx: Component/System errors\n  ERROR: 500,                 // Component error\n  RENDER_ERROR: 501,          // Render failed\n  TIMEOUT: 504,               // Operation timed out\n} as const\n\nexport type ComponentStatusCode = typeof ComponentStatus[keyof typeof ComponentStatus]\n\n// Component interaction types\nexport type InteractionType = \n  | 'render'\n  | 'mount'\n  | 'unmount'\n  | 'click'\n  | 'submit'\n  | 'change'\n  | 'focus'\n  | 'blur'\n  | 'toggle'\n  | 'select'\n  | 'error'\n  | 'custom'\n\n// Trace attributes for components\nexport interface ComponentTraceAttributes {\n  'component.name': string\n  'component.type': string\n  'component.interaction': InteractionType\n  'component.status': ComponentStatusCode\n  'component.props'?: Record<string, unknown>\n  'component.error'?: string\n  'component.duration_ms'?: number\n  'user.action'?: string\n  [key: string]: unknown\n}\n\n// Trace event for components\nexport interface ComponentTraceEvent {\n  name: string\n  timestamp: number\n  attributes: ComponentTraceAttributes\n  status: ComponentStatusCode\n}\n\n// Configuration for traced components\nexport interface TraceConfig {\n  enabled: boolean\n  sampleRate: number // 0.0 to 1.0\n  captureProps: boolean\n  captureErrors: boolean\n  destinations: ('otlp' | 'console' | 'custom')[]\n}\n",
      "type": "registry:lib"
    },
    {
      "path": "registry/new-york-v4/components/client-tracing-provider.tsx",
      "content": "'use client'\n\nimport { useEffect } from 'react'\nimport { initializeClientTracing } from '@/lib/tracing/client-instrumentation'\n\nexport function ClientTracingProvider() {\n  useEffect(() => {\n    initializeClientTracing()\n  }, [])\n\n  return null\n}\n",
      "type": "registry:component"
    }
  ]
}